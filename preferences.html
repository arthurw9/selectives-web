{% extends 'base.html' %}
{% block body %}

<script>

var auto_save_timer_object;
var last_change_timestamp;

// Shim to handle Internet Explorer
if (!Date.now) {
  Date.now = function() { return new Date().getTime(); }
}

function ResetAutoSaveTimer(seconds) {
  // set the timer to save in the given number of seconds
  if (auto_save_timer_object) {
    clearTimeout(auto_save_timer_object);
  }
  auto_save_timer_object = setTimeout(AutoSave, seconds * 1000);
}

function SetModified() {
  // record the time of the last change
  last_change_timestamp = Date.now();
  // set the timer to save in 5 seconds
  ResetAutoSaveTimer(5);
  // Don't let the user leave without saving
  window.onbeforeunload = confirmOnPageExit;
  document.getElementById("status").innerHTML = "Modified";
}

function SetSaved() {
  // Let the user leave without hassle
  window.onbeforeunload = null;
  document.getElementById("status").innerHTML = "Saved";
}

function SetSaveFail() {
  // set the timer to try again in 5 seconds
  ResetAutoSaveTimer(5);
  window.onbeforeunload = confirmOnPageExit;
  document.getElementById("status").innerHTML = "Save Failed";
}

function SetSaving() {
  document.getElementById("status").innerHTML = "Saving...";
}

window.onbeforeunload = null;

function confirmOnPageExit(e) {
  e = e || window.event;
  var msg = '*** SAVE your work first! ***';
  if (e) {
    e.returnValue = msg;
  }
  return msg;
}

function moveRadio() {
  if (document.getElementById("radio1").checked) {
    src = "DontCareSelect";
    dst = "DontWantSelect";
  } else {
    src = "DontCareSelect";
    dst = "WantSelect";
  }
  move(src, dst);
}

function move(src, dst, option) {
  src_select = document.getElementById(src);
  dst_select = document.getElementById(dst);
  idx = src_select.selectedIndex;
  o = src_select.item(idx)
  dst_select.add(o)
  o.selected = false;
  SetModified();
}

function CopySelectToHidden(select_id, hidden_id) {
  select = document.getElementById(select_id);
  str = ""
  for(var idx = 0; idx < select.options.length; idx++) {
    var val = select.item(idx).value;
    str = str + val;
    if (idx < select.length - 1) {
      str = str + ",";
    }
  }
  hidden = document.getElementById(hidden_id);
  hidden.value = str;
}

function submit_it() {
  // clear the unload handler so it doesn't block this submit
  window.onbeforeunload = null;
  CopySelectToHidden("WantSelect", "want");
  CopySelectToHidden("DontWantSelect", "dontwant");
  CopySelectToHidden("DontCareSelect", "dontcare");
  return true;
}

function AutoSave() {
  var save_timestamp = Date.now();
  SetSaving();
  CopySelectToHidden("WantSelect", "want");
  CopySelectToHidden("DontWantSelect", "dontwant");
  CopySelectToHidden("DontCareSelect", "dontcare");
  var request = new XMLHttpRequest();
  request.onload = function() {
    if (request.status == 200) {
      if (save_timestamp > last_change_timestamp) {
        SetSaved();
      }
    } else {
      SetSaveFail();
    }
  }
  request.open("POST", "");
  var formElement = document.querySelector("form");
  var formData = new FormData(formElement);
  request.send(formData);
}
</script>

<h3>Preferences</h3>

Name: {{ student['first'] + ' ' + student['last'] }}<br>
Grade: {{ student['current_grade'] }}<br>
email: {{ student['email'] }}<br><br>

<form method=post>
<input type=hidden name="institution" value="{{ institution }}" />
<input type=hidden name="session" value="{{ session }}" />
<input type=hidden name="student" value="{{ student['email'] }}" />
<input type=hidden id="want" name="want" value="" />
<input type=hidden id="dontwant" name="dontwant" value="" />
<input type=hidden id="dontcare" name="dontcare" value="" />

<table><tr><th>Don't Want</th><th></th><th>Don't Care</th><th></th><th>Want</th></tr>
<tr>
<td><select size=20 id="DontWantSelect" onclick="return move('DontWantSelect', 'DontCareSelect');" multiple>
{% for id in dontwant_ids %}
<option title='{{ classes[id].description }}' value='{{ id }}'>{{ classes[id].name }}</option>
{% endfor %}
</select></td>
<td>&lt;&lt; <input type="radio" name=direction id="radio1"/> &gt;&gt;</td>
<td><select size=20 id="DontCareSelect" onclick="return moveRadio();" multiple>
{% for id in dontcare_ids %}
<option title='{{ classes[id].description }}' value='{{ id }}'>{{ classes[id].name }}</option>
{% endfor %}
</select></td>
<td>&lt;&lt; <input type="radio" name=direction id="radio2" checked/> &gt;&gt;</td>
<td><select size=20 id="WantSelect" onclick="return move('WantSelect', 'DontCareSelect');" multiple>
{% for id in want_ids %}
<option title='{{ classes[id].description }}' value='{{ id }}'>{{ classes[id].name }}</option>
{% endfor %}
</select></td>
</tr></table>
<input type="submit" name=Save value=Save onclick="return submit_it();"/>
<span id=status>Saved</span>
</form>
{% endblock %}

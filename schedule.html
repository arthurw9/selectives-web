{% extends 'base.html' %}
{% block body %}

<script>
function RefreshSpotsAvailable() {
  var request = new XMLHttpRequest();
  request.open("POST", "/spots_available");
  request.onreadystatechange = function() {
    if(request.readyState == 4 && request.status == 200) {
      result = JSON.parse(request.responseText)
      WriteSpotsAvailableToGui(result);
      // TODO: How fast can we refresh before Google complains
      refresh_interval_seconds = 7;
      return;
      setTimeout(RefreshSpotsAvailable,
                 refresh_interval_seconds * 1000);
    }
  }
  var params = new FormData();
  params.append("institution", "{{ institution }}");
  params.append("session", "{{ session }}");
  params.append("student", "{{ student['email'] }}");
  // TODO get class_ids right
  var class_ids = Object.keys(classes_by_id);
  class_ids = JSON.stringify(class_ids);
  params.append("class_ids", class_ids);
  request.send(params);
}

function WriteSpotsAvailableToGui(class_availability) {
  for(c_id in class_availability) {
    dayparts = classes_by_id[c_id]['dayparts'];
    for(idx in dayparts) {
      var daypart = dayparts[idx];
      var dom_element_id = "spots_left_" + daypart + "_" + c_id;
      e = document.getElementById(dom_element_id);
      e.innerHTML = class_availability[c_id];
    }
  }
}

function CheckRequirements() {
  // TODO report if we are meeting all requirements
  // TODO set onbeforeunload to null if all requirements are met.
  window.onbeforeunload = confirmOnPageExit;
  window.onbeforeunload = null;
}

function confirmOnPageExit(e) {
  var msg = 'There are still problems with your registration.';
  e = e || window.event;
  if (e) {
    e.returnValue = msg;
  }
  return msg;
}

classes_by_id = {
{% for class_id in classes_by_id -%}
{{ class_id }} : { 'name' : '{{ classes_by_id[class_id]['name'] }}', 'dayparts': [{% for s in classes_by_id[class_id]['schedule'] -%}
'{{ s['daypart'] }}',
{%- endfor %}]},
{%- endfor %}
};

selected_class_name_by_daypart = {};

function ConfirmConflictingClasses(class_id, daypart) {
  // return true if there are no conflicting classes
  // or if the user is OK with removing the conficts.
  // return false otherwise.
  dayparts = classes_by_id[class_id]['dayparts'];
  conflicting_classes = [];
  for (var i = 0; i < dayparts.length; i++) {
    if (dayparts[i] == daypart) {
      // presumably the user knows and is ok if (s)he is removing 
      // a class in the current daypart.
      continue;
    }
    class_name = selected_class_name_by_daypart[dayparts[i]];
    if (class_name) {
      conflicting_classes.push(class_name);
    }
  }
  if (conflicting_classes.length == 0) {
    return true;
  }
  return confirm(classes_by_id[class_id]['name'] + " meets on " +
                 dayparts.join(", ") + 
                 "\nThis will replace the following classes:\n" +
                 conflicting_classes.join(", ") +
                 "\nDo you want to continue?");
}

function AddClass(class_id, daypart) {
  // save the new class id in the form's hidden field
  form_element = document.forms[0];
  form_element.class_id.value = class_id;
  if (!ConfirmConflictingClasses(class_id, daypart)) {
    return;
  }
  // allow the page to submit without prompting the user
  window.onbeforeunload = null;
  // submit the form
  form_element.submit();
}

// TODO: move these color choices into the style sheet
var noSelectionColor = '#eeeeff'; // light-grey
var hoverColor = '#bbbbbb'; // grey
var selectionColor = '#8888ff'; // blue

// TODO: support removing a class after the backend supports this.
function setClickedBackground(daypart, class_id, element) {
  if (element.selected) {
    // TODO: support removing a class after the backend supports this.
    return;
  }
  var loading_gif = document.getElementById(daypart + "_" + class_id + "_loading_gif");
  loading_gif.style.visibility = "visible";
  element.selected = true;
  element.style.background = selectionColor;
  AddClass(class_id, daypart)
}

function setMouseOverBackground(element) {
  if (element.selected) {
    // If mousing over a clicked-on item, don't do anything.
    return;
  }
  element.style.background = hoverColor;
}

function setMouseOutBackground(element) {
  if (element.selected) {
    // If mousing over a clicked-on item, don't do anything.
    return;
  }
  element.style.background = noSelectionColor;
}

function setInitialSchedule() {
  {% if schedule %}
    {% for class_id in schedule %}
      {% if class_id %}
        {% for s in classes_by_id[class_id]['schedule'] %}
  e = document.getElementById("{{ s['daypart'] }}_{{ class_id }}");
  e.style.background = selectionColor;
  e.class_name = classes_by_id[{{ class_id }}]['name']
  e.selected = true;
  selected_class_name_by_daypart["{{ s['daypart'] }}"] = e.class_name;
        {% endfor %}
      {% endif %}
    {% endfor %}
  {% endif %}
}
</script>

<h3>Schedule</h3>

Name: {{ student['first'] + ' ' + student['last'] }}<br>
Grade: {{ student['current_grade'] }}<br>
email: {{ student['email'] }}<br>
<a href="#mycatalog">View My Course Catalog</a><br><br>

<form method=post>
<input type=hidden name="institution" value="{{ institution }}" />
<input type=hidden name="session" value="{{ session }}" />
<input type=hidden name="student" value="{{ student['email'] }}" />
<input type=hidden name="class_id" />
<table>
  {% for row in dayparts_ordered %}
  <tr>
    {% for daypart in row %}
      <td class="schedHeader">{{ daypart }}</td>
    {% endfor %}
  </tr>
  <tr>
    {% for daypart in row %}
      <td class="schedTableData">
        <ol id="{{daypart}}" class="schedOrderedList">
        {% for c in classes_by_daypart[daypart] %}
          <li class="schedListItem" id="{{daypart}}_{{c['id']}}"
              title="{{c['hover_text']}}"
              onclick="setClickedBackground('{{daypart}}', {{c['id']}}, this);"
              onmouseover="setMouseOverBackground(this);"
              onmouseout="setMouseOutBackground(this);">
              <span id='spots_left_{{daypart}}_{{c['id']}}' style="background-color:lightgreen;"></span>
              {{ c['name'] }}
              <img src="/images/379.gif" id="{{daypart}}_{{c['id']}}_loading_gif" alt="loading gif" align="right" style="width:15%;visibility:hidden"/>
          </li>
        {% endfor %}
        </ol>
      </td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>
</form>
<script>
setInitialSchedule();
RefreshSpotsAvailable();
</script>

<a name="mycatalog"></a>
<h2>Course Catalog for {{ student['first'] + ' ' + student['last'] }}</h2>

{% for c in classes_for_catalog %}
  <h3>{{c['name']}}</h3>
  <b>Teacher: </b>{{c['instructor']}}<br>
  <b>Maximum Enrollment: </b>{{c['max_enrollment']}}<br>
  <b>Schedule: </b>
  {{c['schedule'][0]['daypart']}}
  {% if c['schedule']|length > 1 %}
    {% for s in c['schedule'][1:] %}
      / {{s['daypart']}}
    {% endfor %}
  {% endif %}<br>
  {% if c['donation'] %}
    <b>Suggested Donation: </b>{{c['donation']}}<br>
  {% endif %}
  <br>
  {% if c['description'] %}
    {% for line in c['description'].splitlines() %}
      {{ line }}<br>
    {% endfor %}
   <br>
  {% endif %}
  <hr width="80%" align="left">
{% endfor %}

{% endblock %}
